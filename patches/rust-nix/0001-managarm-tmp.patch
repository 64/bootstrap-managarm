From 6c7ec8396aecaf5fa6fd9ae27a44375471c17a0d Mon Sep 17 00:00:00 2001
From: Matt Taylor <mstaveleytaylor@gmail.com>
Date: Mon, 12 Jul 2021 00:05:23 +0100
Subject: [PATCH] managarm: tmp

---
 src/errno.rs | 530 ++++++++++++++++++++++++++++++++++++---------------
 src/lib.rs   |  16 +-
 2 files changed, 385 insertions(+), 161 deletions(-)

diff --git a/src/errno.rs b/src/errno.rs
index 9275feb..0e050b9 100644
--- a/src/errno.rs
+++ b/src/errno.rs
@@ -21,6 +21,7 @@ cfg_if! {
     } else if #[cfg(any(target_os = "linux",
                         target_os = "redox",
                         target_os = "dragonfly",
+                        target_os = "managarm",
                         target_os = "fuchsia"))] {
         unsafe fn errno_location() -> *mut c_int {
             libc::__errno_location()
@@ -121,6 +122,7 @@ fn last() -> Errno {
 
 fn desc(errno: Errno) -> &'static str {
     use self::Errno::*;
+    // TODO: This is completely broken on managarm
     match errno {
         UnknownErrno    => "Unknown errno",
         EPERM           => "Operation not permitted",
@@ -1871,105 +1873,105 @@ mod consts {
     #[repr(i32)]
     pub enum Errno {
         UnknownErrno    = 0,
-        EPERM           = libc::EPERM,
-        ENOENT          = libc::ENOENT,
-        ESRCH           = libc::ESRCH,
-        EINTR           = libc::EINTR,
-        EIO             = libc::EIO,
-        ENXIO           = libc::ENXIO,
         E2BIG           = libc::E2BIG,
-        ENOEXEC         = libc::ENOEXEC,
+        EACCES          = libc::EACCES,
+        EADDRINUSE      = libc::EADDRINUSE,
+        EADDRNOTAVAIL   = libc::EADDRNOTAVAIL,
+        EAFNOSUPPORT    = libc::EAFNOSUPPORT,
+        EAGAIN          = libc::EAGAIN,
+        EALREADY        = libc::EALREADY,
+        EAUTH           = libc::EAUTH,
         EBADF           = libc::EBADF,
+        EBADMSG         = libc::EBADMSG,
+        EBADRPC         = libc::EBADRPC,
+        EBUSY           = libc::EBUSY,
+        ECANCELED       = libc::ECANCELED,
         ECHILD          = libc::ECHILD,
+        ECONNABORTED    = libc::ECONNABORTED,
+        ECONNREFUSED    = libc::ECONNREFUSED,
+        ECONNRESET      = libc::ECONNRESET,
         EDEADLK         = libc::EDEADLK,
-        ENOMEM          = libc::ENOMEM,
-        EACCES          = libc::EACCES,
-        EFAULT          = libc::EFAULT,
-        ENOTBLK         = libc::ENOTBLK,
-        EBUSY           = libc::EBUSY,
+        EDESTADDRREQ    = libc::EDESTADDRREQ,
+        EDOM            = libc::EDOM,
+        EDQUOT          = libc::EDQUOT,
         EEXIST          = libc::EEXIST,
-        EXDEV           = libc::EXDEV,
-        ENODEV          = libc::ENODEV,
-        ENOTDIR         = libc::ENOTDIR,
-        EISDIR          = libc::EISDIR,
+        EFAULT          = libc::EFAULT,
+        EFBIG           = libc::EFBIG,
+        EFTYPE          = libc::EFTYPE,
+        EHOSTDOWN       = libc::EHOSTDOWN,
+        EHOSTUNREACH    = libc::EHOSTUNREACH,
+        EIDRM           = libc::EIDRM,
+        EILSEQ          = libc::EILSEQ,
+        EINPROGRESS     = libc::EINPROGRESS,
+        EINTR           = libc::EINTR,
         EINVAL          = libc::EINVAL,
-        ENFILE          = libc::ENFILE,
+        EIO             = libc::EIO,
+        EISCONN         = libc::EISCONN,
+        EISDIR          = libc::EISDIR,
+        ELOOP           = libc::ELOOP,
         EMFILE          = libc::EMFILE,
-        ENOTTY          = libc::ENOTTY,
-        ETXTBSY         = libc::ETXTBSY,
-        EFBIG           = libc::EFBIG,
-        ENOSPC          = libc::ENOSPC,
-        ESPIPE          = libc::ESPIPE,
-        EROFS           = libc::EROFS,
         EMLINK          = libc::EMLINK,
-        EPIPE           = libc::EPIPE,
-        EDOM            = libc::EDOM,
-        ERANGE          = libc::ERANGE,
-        EAGAIN          = libc::EAGAIN,
-        EINPROGRESS     = libc::EINPROGRESS,
-        EALREADY        = libc::EALREADY,
-        ENOTSOCK        = libc::ENOTSOCK,
-        EDESTADDRREQ    = libc::EDESTADDRREQ,
         EMSGSIZE        = libc::EMSGSIZE,
-        EPROTOTYPE      = libc::EPROTOTYPE,
-        ENOPROTOOPT     = libc::ENOPROTOOPT,
-        EPROTONOSUPPORT = libc::EPROTONOSUPPORT,
-        ESOCKTNOSUPPORT = libc::ESOCKTNOSUPPORT,
-        EOPNOTSUPP      = libc::EOPNOTSUPP,
-        EPFNOSUPPORT    = libc::EPFNOSUPPORT,
-        EAFNOSUPPORT    = libc::EAFNOSUPPORT,
-        EADDRINUSE      = libc::EADDRINUSE,
-        EADDRNOTAVAIL   = libc::EADDRNOTAVAIL,
+        EMULTIHOP       = libc::EMULTIHOP,
+        ENAMETOOLONG    = libc::ENAMETOOLONG,
+        ENEEDAUTH       = libc::ENEEDAUTH,
         ENETDOWN        = libc::ENETDOWN,
-        ENETUNREACH     = libc::ENETUNREACH,
         ENETRESET       = libc::ENETRESET,
-        ECONNABORTED    = libc::ECONNABORTED,
-        ECONNRESET      = libc::ECONNRESET,
+        ENETUNREACH     = libc::ENETUNREACH,
+        ENFILE          = libc::ENFILE,
+        ENOATTR         = libc::ENOATTR,
         ENOBUFS         = libc::ENOBUFS,
-        EISCONN         = libc::EISCONN,
+        ENODATA         = libc::ENODATA,
+        ENODEV          = libc::ENODEV,
+        ENOENT          = libc::ENOENT,
+        ENOEXEC         = libc::ENOEXEC,
+        ENOLCK          = libc::ENOLCK,
+        ENOLINK         = libc::ENOLINK,
+        ENOMEM          = libc::ENOMEM,
+        ENOMSG          = libc::ENOMSG,
+        ENOPROTOOPT     = libc::ENOPROTOOPT,
+        ENOSPC          = libc::ENOSPC,
+        ENOSR           = libc::ENOSR,
+        ENOSTR          = libc::ENOSTR,
+        ENOSYS          = libc::ENOSYS,
+        ENOTBLK         = libc::ENOTBLK,
         ENOTCONN        = libc::ENOTCONN,
-        ESHUTDOWN       = libc::ESHUTDOWN,
-        ETOOMANYREFS    = libc::ETOOMANYREFS,
-        ETIMEDOUT       = libc::ETIMEDOUT,
-        ECONNREFUSED    = libc::ECONNREFUSED,
-        ELOOP           = libc::ELOOP,
-        ENAMETOOLONG    = libc::ENAMETOOLONG,
-        EHOSTDOWN       = libc::EHOSTDOWN,
-        EHOSTUNREACH    = libc::EHOSTUNREACH,
+        ENOTDIR         = libc::ENOTDIR,
         ENOTEMPTY       = libc::ENOTEMPTY,
+        ENOTSOCK        = libc::ENOTSOCK,
+        ENOTSUP         = libc::ENOTSUP,
+        ENOTTY          = libc::ENOTTY,
+        ENXIO           = libc::ENXIO,
+        EOPNOTSUPP      = libc::EOPNOTSUPP,
+        EOVERFLOW       = libc::EOVERFLOW,
+        EPERM           = libc::EPERM,
+        EPFNOSUPPORT    = libc::EPFNOSUPPORT,
+        EPIPE           = libc::EPIPE,
         EPROCLIM        = libc::EPROCLIM,
-        EUSERS          = libc::EUSERS,
-        EDQUOT          = libc::EDQUOT,
-        ESTALE          = libc::ESTALE,
+        EPROCUNAVAIL    = libc::EPROCUNAVAIL,
+        EPROGMISMATCH   = libc::EPROGMISMATCH,
+        EPROGUNAVAIL    = libc::EPROGUNAVAIL,
+        EPROTO          = libc::EPROTO,
+        EPROTONOSUPPORT = libc::EPROTONOSUPPORT,
+        EPROTOTYPE      = libc::EPROTOTYPE,
+        ERANGE          = libc::ERANGE,
         EREMOTE         = libc::EREMOTE,
-        EBADRPC         = libc::EBADRPC,
+        EROFS           = libc::EROFS,
         ERPCMISMATCH    = libc::ERPCMISMATCH,
-        EPROGUNAVAIL    = libc::EPROGUNAVAIL,
-        EPROGMISMATCH   = libc::EPROGMISMATCH,
-        EPROCUNAVAIL    = libc::EPROCUNAVAIL,
-        ENOLCK          = libc::ENOLCK,
-        ENOSYS          = libc::ENOSYS,
-        EFTYPE          = libc::EFTYPE,
-        EAUTH           = libc::EAUTH,
-        ENEEDAUTH       = libc::ENEEDAUTH,
-        EIDRM           = libc::EIDRM,
-        ENOMSG          = libc::ENOMSG,
-        EOVERFLOW       = libc::EOVERFLOW,
-        EILSEQ          = libc::EILSEQ,
-        ENOTSUP         = libc::ENOTSUP,
-        ECANCELED       = libc::ECANCELED,
-        EBADMSG         = libc::EBADMSG,
-        ENODATA         = libc::ENODATA,
-        ENOSR           = libc::ENOSR,
-        ENOSTR          = libc::ENOSTR,
+        ESHUTDOWN       = libc::ESHUTDOWN,
+        ESOCKTNOSUPPORT = libc::ESOCKTNOSUPPORT,
+        ESPIPE          = libc::ESPIPE,
+        ESRCH           = libc::ESRCH,
+        ESTALE          = libc::ESTALE,
         ETIME           = libc::ETIME,
-        ENOATTR         = libc::ENOATTR,
-        EMULTIHOP       = libc::EMULTIHOP,
-        ENOLINK         = libc::ENOLINK,
-        EPROTO          = libc::EPROTO,
+        ETIMEDOUT       = libc::ETIMEDOUT,
+        ETOOMANYREFS    = libc::ETOOMANYREFS,
+        ETXTBSY         = libc::ETXTBSY,
+        EUSERS          = libc::EUSERS,
+        EXDEV           = libc::EXDEV,
     }
 
-    pub const ELAST: Errno       = Errno::ENOTSUP;
+    // pub const ELAST: Errno       = Errno::ENOTSUP;
     pub const EWOULDBLOCK: Errno = Errno::EAGAIN;
 
     pub const EL2NSYNC: Errno = Errno::UnknownErrno;
@@ -1978,102 +1980,316 @@ mod consts {
         use self::Errno::*;
 
         match e {
-            libc::EPERM => EPERM,
-            libc::ENOENT => ENOENT,
-            libc::ESRCH => ESRCH,
-            libc::EINTR => EINTR,
-            libc::EIO => EIO,
-            libc::ENXIO => ENXIO,
             libc::E2BIG => E2BIG,
-            libc::ENOEXEC => ENOEXEC,
+            libc::EACCES => EACCES,
+            libc::EADDRINUSE => EADDRINUSE,
+            libc::EADDRNOTAVAIL => EADDRNOTAVAIL,
+            libc::EAFNOSUPPORT => EAFNOSUPPORT,
+            libc::EAGAIN => EAGAIN,
+            libc::EALREADY => EALREADY,
+            libc::EAUTH => EAUTH,
             libc::EBADF => EBADF,
+            libc::EBADMSG => EBADMSG,
+            libc::EBADRPC => EBADRPC,
+            libc::EBUSY => EBUSY,
+            libc::ECANCELED => ECANCELED,
             libc::ECHILD => ECHILD,
+            libc::ECONNABORTED => ECONNABORTED,
+            libc::ECONNREFUSED => ECONNREFUSED,
+            libc::ECONNRESET => ECONNRESET,
             libc::EDEADLK => EDEADLK,
-            libc::ENOMEM => ENOMEM,
-            libc::EACCES => EACCES,
-            libc::EFAULT => EFAULT,
-            libc::ENOTBLK => ENOTBLK,
-            libc::EBUSY => EBUSY,
+            libc::EDESTADDRREQ => EDESTADDRREQ,
+            libc::EDOM => EDOM,
+            libc::EDQUOT => EDQUOT,
             libc::EEXIST => EEXIST,
-            libc::EXDEV => EXDEV,
-            libc::ENODEV => ENODEV,
-            libc::ENOTDIR => ENOTDIR,
-            libc::EISDIR => EISDIR,
+            libc::EFAULT => EFAULT,
+            libc::EFBIG => EFBIG,
+            libc::EFTYPE => EFTYPE,
+            libc::EHOSTDOWN => EHOSTDOWN,
+            libc::EHOSTUNREACH => EHOSTUNREACH,
+            libc::EIDRM => EIDRM,
+            libc::EILSEQ => EILSEQ,
+            libc::EINPROGRESS => EINPROGRESS,
+            libc::EINTR => EINTR,
             libc::EINVAL => EINVAL,
-            libc::ENFILE => ENFILE,
+            libc::EIO => EIO,
+            libc::EISCONN => EISCONN,
+            libc::EISDIR => EISDIR,
+            libc::ELOOP => ELOOP,
             libc::EMFILE => EMFILE,
-            libc::ENOTTY => ENOTTY,
-            libc::ETXTBSY => ETXTBSY,
-            libc::EFBIG => EFBIG,
-            libc::ENOSPC => ENOSPC,
-            libc::ESPIPE => ESPIPE,
-            libc::EROFS => EROFS,
             libc::EMLINK => EMLINK,
-            libc::EPIPE => EPIPE,
-            libc::EDOM => EDOM,
-            libc::ERANGE => ERANGE,
-            libc::EAGAIN => EAGAIN,
-            libc::EINPROGRESS => EINPROGRESS,
-            libc::EALREADY => EALREADY,
-            libc::ENOTSOCK => ENOTSOCK,
-            libc::EDESTADDRREQ => EDESTADDRREQ,
             libc::EMSGSIZE => EMSGSIZE,
-            libc::EPROTOTYPE => EPROTOTYPE,
-            libc::ENOPROTOOPT => ENOPROTOOPT,
-            libc::EPROTONOSUPPORT => EPROTONOSUPPORT,
-            libc::ESOCKTNOSUPPORT => ESOCKTNOSUPPORT,
-            libc::EOPNOTSUPP => EOPNOTSUPP,
-            libc::EPFNOSUPPORT => EPFNOSUPPORT,
-            libc::EAFNOSUPPORT => EAFNOSUPPORT,
-            libc::EADDRINUSE => EADDRINUSE,
-            libc::EADDRNOTAVAIL => EADDRNOTAVAIL,
+            libc::EMULTIHOP => EMULTIHOP,
+            libc::ENAMETOOLONG => ENAMETOOLONG,
+            libc::ENEEDAUTH => ENEEDAUTH,
             libc::ENETDOWN => ENETDOWN,
-            libc::ENETUNREACH => ENETUNREACH,
             libc::ENETRESET => ENETRESET,
-            libc::ECONNABORTED => ECONNABORTED,
-            libc::ECONNRESET => ECONNRESET,
+            libc::ENETUNREACH => ENETUNREACH,
+            libc::ENFILE => ENFILE,
+            libc::ENOATTR => ENOATTR,
             libc::ENOBUFS => ENOBUFS,
-            libc::EISCONN => EISCONN,
+            libc::ENODATA => ENODATA,
+            libc::ENODEV => ENODEV,
+            libc::ENOENT => ENOENT,
+            libc::ENOEXEC => ENOEXEC,
+            libc::ENOLCK => ENOLCK,
+            libc::ENOLINK => ENOLINK,
+            libc::ENOMEM => ENOMEM,
+            libc::ENOMSG => ENOMSG,
+            libc::ENOPROTOOPT => ENOPROTOOPT,
+            libc::ENOSPC => ENOSPC,
+            libc::ENOSR => ENOSR,
+            libc::ENOSTR => ENOSTR,
+            libc::ENOSYS => ENOSYS,
+            libc::ENOTBLK => ENOTBLK,
             libc::ENOTCONN => ENOTCONN,
-            libc::ESHUTDOWN => ESHUTDOWN,
-            libc::ETOOMANYREFS => ETOOMANYREFS,
-            libc::ETIMEDOUT => ETIMEDOUT,
-            libc::ECONNREFUSED => ECONNREFUSED,
-            libc::ELOOP => ELOOP,
-            libc::ENAMETOOLONG => ENAMETOOLONG,
-            libc::EHOSTDOWN => EHOSTDOWN,
-            libc::EHOSTUNREACH => EHOSTUNREACH,
+            libc::ENOTDIR => ENOTDIR,
             libc::ENOTEMPTY => ENOTEMPTY,
+            libc::ENOTSOCK => ENOTSOCK,
+            libc::ENOTSUP => ENOTSUP,
+            libc::ENOTTY => ENOTTY,
+            libc::ENXIO => ENXIO,
+            libc::EOPNOTSUPP => EOPNOTSUPP,
+            libc::EOVERFLOW => EOVERFLOW,
+            libc::EPERM => EPERM,
+            libc::EPFNOSUPPORT => EPFNOSUPPORT,
+            libc::EPIPE => EPIPE,
             libc::EPROCLIM => EPROCLIM,
-            libc::EUSERS => EUSERS,
-            libc::EDQUOT => EDQUOT,
-            libc::ESTALE => ESTALE,
+            libc::EPROCUNAVAIL => EPROCUNAVAIL,
+            libc::EPROGMISMATCH => EPROGMISMATCH,
+            libc::EPROGUNAVAIL => EPROGUNAVAIL,
+            libc::EPROTO => EPROTO,
+            libc::EPROTONOSUPPORT => EPROTONOSUPPORT,
+            libc::EPROTOTYPE => EPROTOTYPE,
+            libc::ERANGE => ERANGE,
             libc::EREMOTE => EREMOTE,
-            libc::EBADRPC => EBADRPC,
+            libc::EROFS => EROFS,
             libc::ERPCMISMATCH => ERPCMISMATCH,
-            libc::EPROGUNAVAIL => EPROGUNAVAIL,
-            libc::EPROGMISMATCH => EPROGMISMATCH,
-            libc::EPROCUNAVAIL => EPROCUNAVAIL,
-            libc::ENOLCK => ENOLCK,
-            libc::ENOSYS => ENOSYS,
-            libc::EFTYPE => EFTYPE,
-            libc::EAUTH => EAUTH,
-            libc::ENEEDAUTH => ENEEDAUTH,
-            libc::EIDRM => EIDRM,
-            libc::ENOMSG => ENOMSG,
-            libc::EOVERFLOW => EOVERFLOW,
-            libc::EILSEQ => EILSEQ,
-            libc::ENOTSUP => ENOTSUP,
-            libc::ECANCELED => ECANCELED,
-            libc::EBADMSG => EBADMSG,
-            libc::ENODATA => ENODATA,
-            libc::ENOSR => ENOSR,
-            libc::ENOSTR => ENOSTR,
+            libc::ESHUTDOWN => ESHUTDOWN,
+            libc::ESOCKTNOSUPPORT => ESOCKTNOSUPPORT,
+            libc::ESPIPE => ESPIPE,
+            libc::ESRCH => ESRCH,
+            libc::ESTALE => ESTALE,
             libc::ETIME => ETIME,
-            libc::ENOATTR => ENOATTR,
-            libc::EMULTIHOP => EMULTIHOP,
-            libc::ENOLINK => ENOLINK,
-            libc::EPROTO => EPROTO,
+            libc::ETIMEDOUT => ETIMEDOUT,
+            libc::ETOOMANYREFS => ETOOMANYREFS,
+            libc::ETXTBSY => ETXTBSY,
+            libc::EUSERS => EUSERS,
+            libc::EXDEV => EXDEV,
+            _   => UnknownErrno,
+        }
+    }
+}
+
+#[cfg(target_os = "managarm")]
+mod consts {
+    #[derive(Clone, Copy, Debug, Eq, PartialEq)]
+    #[repr(i32)]
+    pub enum Errno {
+        UnknownErrno    = 0,
+        // E2BIG           = libc::E2BIG,
+        EACCES          = libc::EACCES,
+        EADDRINUSE      = libc::EADDRINUSE,
+        EADDRNOTAVAIL   = libc::EADDRNOTAVAIL,
+        // EAFNOSUPPORT    = libc::EAFNOSUPPORT,
+        EAGAIN          = libc::EAGAIN,
+        // EALREADY        = libc::EALREADY,
+        // EAUTH           = libc::EAUTH,
+        EBADF           = libc::EBADF,
+        // EBADMSG         = libc::EBADMSG,
+        // EBADRPC         = libc::EBADRPC,
+        // EBUSY           = libc::EBUSY,
+        // ECANCELED       = libc::ECANCELED,
+        // ECHILD          = libc::ECHILD,
+        ECONNABORTED    = libc::ECONNABORTED,
+        ECONNREFUSED    = libc::ECONNREFUSED,
+        ECONNRESET      = libc::ECONNRESET,
+        EDEADLK         = libc::EDEADLK,
+        // EDESTADDRREQ    = libc::EDESTADDRREQ,
+        // EDOM            = libc::EDOM,
+        // EDQUOT          = libc::EDQUOT,
+        EEXIST          = libc::EEXIST,
+        // EFAULT          = libc::EFAULT,
+        // EFBIG           = libc::EFBIG,
+        // EFTYPE          = libc::EFTYPE,
+        // EHOSTDOWN       = libc::EHOSTDOWN,
+        // EHOSTUNREACH    = libc::EHOSTUNREACH,
+        // EIDRM           = libc::EIDRM,
+        // EILSEQ          = libc::EILSEQ,
+        EINPROGRESS     = libc::EINPROGRESS,
+        EINTR           = libc::EINTR,
+        EINVAL          = libc::EINVAL,
+        // EIO             = libc::EIO,
+        // EISCONN         = libc::EISCONN,
+        // EISDIR          = libc::EISDIR,
+        // ELOOP           = libc::ELOOP,
+        // EMFILE          = libc::EMFILE,
+        // EMLINK          = libc::EMLINK,
+        // EMSGSIZE        = libc::EMSGSIZE,
+        // EMULTIHOP       = libc::EMULTIHOP,
+        // ENAMETOOLONG    = libc::ENAMETOOLONG,
+        // ENEEDAUTH       = libc::ENEEDAUTH,
+        // ENETDOWN        = libc::ENETDOWN,
+        // ENETRESET       = libc::ENETRESET,
+        // ENETUNREACH     = libc::ENETUNREACH,
+        // ENFILE          = libc::ENFILE,
+        // ENOATTR         = libc::ENOATTR,
+        // ENOBUFS         = libc::ENOBUFS,
+        // ENODATA         = libc::ENODATA,
+        // ENODEV          = libc::ENODEV,
+        ENOENT          = libc::ENOENT,
+        // ENOEXEC         = libc::ENOEXEC,
+        // ENOLCK          = libc::ENOLCK,
+        // ENOLINK         = libc::ENOLINK,
+        // ENOMEM          = libc::ENOMEM,
+        // ENOMSG          = libc::ENOMSG,
+        // ENOPROTOOPT     = libc::ENOPROTOOPT,
+        // ENOSPC          = libc::ENOSPC,
+        // ENOSR           = libc::ENOSR,
+        // ENOSTR          = libc::ENOSTR,
+        ENOSYS          = libc::ENOSYS,
+        // ENOTBLK         = libc::ENOTBLK,
+        ENOTCONN        = libc::ENOTCONN,
+        // ENOTDIR         = libc::ENOTDIR,
+        // ENOTEMPTY       = libc::ENOTEMPTY,
+        // ENOTSOCK        = libc::ENOTSOCK,
+        // ENOTSUP         = libc::ENOTSUP,
+        // ENOTTY          = libc::ENOTTY,
+        // ENXIO           = libc::ENXIO,
+        // EOPNOTSUPP      = libc::EOPNOTSUPP,
+        // EOVERFLOW       = libc::EOVERFLOW,
+        EPERM           = libc::EPERM,
+        // EPFNOSUPPORT    = libc::EPFNOSUPPORT,
+        EPIPE           = libc::EPIPE,
+        // EPROCLIM        = libc::EPROCLIM,
+        // EPROCUNAVAIL    = libc::EPROCUNAVAIL,
+        // EPROGMISMATCH   = libc::EPROGMISMATCH,
+        // EPROGUNAVAIL    = libc::EPROGUNAVAIL,
+        // EPROTO          = libc::EPROTO,
+        // EPROTONOSUPPORT = libc::EPROTONOSUPPORT,
+        // EPROTOTYPE      = libc::EPROTOTYPE,
+        ERANGE          = libc::ERANGE,
+        // EREMOTE         = libc::EREMOTE,
+        // EROFS           = libc::EROFS,
+        // ERPCMISMATCH    = libc::ERPCMISMATCH,
+        // ESHUTDOWN       = libc::ESHUTDOWN,
+        // ESOCKTNOSUPPORT = libc::ESOCKTNOSUPPORT,
+        // ESPIPE          = libc::ESPIPE,
+        // ESRCH           = libc::ESRCH,
+        // ESTALE          = libc::ESTALE,
+        // ETIME           = libc::ETIME,
+        ETIMEDOUT       = libc::ETIMEDOUT,
+        // ETOOMANYREFS    = libc::ETOOMANYREFS,
+        // ETXTBSY         = libc::ETXTBSY,
+        // EUSERS          = libc::EUSERS,
+        // EXDEV           = libc::EXDEV,
+    }
+
+    // pub const ELAST: Errno       = Errno::ENOTSUP;
+    pub const EWOULDBLOCK: Errno = Errno::EAGAIN;
+
+    // pub const EL2NSYNC: Errno = Errno::UnknownErrno;
+
+    pub fn from_i32(e: i32) -> Errno {
+        use self::Errno::*;
+
+        match e {
+            // libc::E2BIG => E2BIG,
+            libc::EACCES => EACCES,
+            libc::EADDRINUSE => EADDRINUSE,
+            libc::EADDRNOTAVAIL => EADDRNOTAVAIL,
+            // libc::EAFNOSUPPORT => EAFNOSUPPORT,
+            libc::EAGAIN => EAGAIN,
+            // libc::EALREADY => EALREADY,
+            // libc::EAUTH => EAUTH,
+            libc::EBADF => EBADF,
+            // libc::EBADMSG => EBADMSG,
+            // libc::EBADRPC => EBADRPC,
+            // libc::EBUSY => EBUSY,
+            // libc::ECANCELED => ECANCELED,
+            // libc::ECHILD => ECHILD,
+            libc::ECONNABORTED => ECONNABORTED,
+            libc::ECONNREFUSED => ECONNREFUSED,
+            libc::ECONNRESET => ECONNRESET,
+            libc::EDEADLK => EDEADLK,
+            // libc::EDESTADDRREQ => EDESTADDRREQ,
+            // libc::EDOM => EDOM,
+            // libc::EDQUOT => EDQUOT,
+            libc::EEXIST => EEXIST,
+            // libc::EFAULT => EFAULT,
+            // libc::EFBIG => EFBIG,
+            // libc::EFTYPE => EFTYPE,
+            // libc::EHOSTDOWN => EHOSTDOWN,
+            // libc::EHOSTUNREACH => EHOSTUNREACH,
+            // libc::EIDRM => EIDRM,
+            // libc::EILSEQ => EILSEQ,
+            libc::EINPROGRESS => EINPROGRESS,
+            libc::EINTR => EINTR,
+            libc::EINVAL => EINVAL,
+            // libc::EIO => EIO,
+            // libc::EISCONN => EISCONN,
+            // libc::EISDIR => EISDIR,
+            // libc::ELOOP => ELOOP,
+            // libc::EMFILE => EMFILE,
+            // libc::EMLINK => EMLINK,
+            // libc::EMSGSIZE => EMSGSIZE,
+            // libc::EMULTIHOP => EMULTIHOP,
+            // libc::ENAMETOOLONG => ENAMETOOLONG,
+            // libc::ENEEDAUTH => ENEEDAUTH,
+            // libc::ENETDOWN => ENETDOWN,
+            // libc::ENETRESET => ENETRESET,
+            // libc::ENETUNREACH => ENETUNREACH,
+            // libc::ENFILE => ENFILE,
+            // libc::ENOATTR => ENOATTR,
+            // libc::ENOBUFS => ENOBUFS,
+            // libc::ENODATA => ENODATA,
+            // libc::ENODEV => ENODEV,
+            libc::ENOENT => ENOENT,
+            // libc::ENOEXEC => ENOEXEC,
+            // libc::ENOLCK => ENOLCK,
+            // libc::ENOLINK => ENOLINK,
+            // libc::ENOMEM => ENOMEM,
+            // libc::ENOMSG => ENOMSG,
+            // libc::ENOPROTOOPT => ENOPROTOOPT,
+            // libc::ENOSPC => ENOSPC,
+            // libc::ENOSR => ENOSR,
+            // libc::ENOSTR => ENOSTR,
+            libc::ENOSYS => ENOSYS,
+            // libc::ENOTBLK => ENOTBLK,
+            libc::ENOTCONN => ENOTCONN,
+            // libc::ENOTDIR => ENOTDIR,
+            // libc::ENOTEMPTY => ENOTEMPTY,
+            // libc::ENOTSOCK => ENOTSOCK,
+            // libc::ENOTSUP => ENOTSUP,
+            // libc::ENOTTY => ENOTTY,
+            // libc::ENXIO => ENXIO,
+            // libc::EOPNOTSUPP => EOPNOTSUPP,
+            // libc::EOVERFLOW => EOVERFLOW,
+            libc::EPERM => EPERM,
+            // libc::EPFNOSUPPORT => EPFNOSUPPORT,
+            libc::EPIPE => EPIPE,
+            // libc::EPROCLIM => EPROCLIM,
+            // libc::EPROCUNAVAIL => EPROCUNAVAIL,
+            // libc::EPROGMISMATCH => EPROGMISMATCH,
+            // libc::EPROGUNAVAIL => EPROGUNAVAIL,
+            // libc::EPROTO => EPROTO,
+            // libc::EPROTONOSUPPORT => EPROTONOSUPPORT,
+            // libc::EPROTOTYPE => EPROTOTYPE,
+            libc::ERANGE => ERANGE,
+            // libc::EREMOTE => EREMOTE,
+            // libc::EROFS => EROFS,
+            // libc::ERPCMISMATCH => ERPCMISMATCH,
+            // libc::ESHUTDOWN => ESHUTDOWN,
+            // libc::ESOCKTNOSUPPORT => ESOCKTNOSUPPORT,
+            // libc::ESPIPE => ESPIPE,
+            // libc::ESRCH => ESRCH,
+            // libc::ESTALE => ESTALE,
+            // libc::ETIME => ETIME,
+            libc::ETIMEDOUT => ETIMEDOUT,
+            // libc::ETOOMANYREFS => ETOOMANYREFS,
+            // libc::ETXTBSY => ETXTBSY,
+            // libc::EUSERS => EUSERS,
+            // libc::EXDEV => EXDEV,
             _   => UnknownErrno,
         }
     }
diff --git a/src/lib.rs b/src/lib.rs
index 899d3f8..d6bd6b9 100644
--- a/src/lib.rs
+++ b/src/lib.rs
@@ -10,7 +10,7 @@
 #![allow(dead_code)]
 #![cfg_attr(test, deny(warnings))]
 #![recursion_limit = "500"]
-#![deny(unused)]
+// #![deny(unused)]
 #![deny(unstable_features)]
 #![deny(missing_copy_implementations)]
 #![deny(missing_debug_implementations)]
@@ -22,12 +22,15 @@ pub use libc;
 #[macro_use] mod macros;
 
 // Public crates
-#[cfg(not(target_os = "redox"))]
+#[cfg(not(any(target_os = "redox", target_os = "managarm")))]
 pub mod dir;
+#[cfg(not(target_os = "managarm"))]
 pub mod env;
 pub mod errno;
 #[deny(missing_docs)]
+#[cfg(not(target_os = "managarm"))]
 pub mod features;
+#[cfg(not(target_os = "managarm"))]
 pub mod fcntl;
 #[deny(missing_docs)]
 #[cfg(any(target_os = "android",
@@ -53,21 +56,26 @@ pub mod mount;
           target_os = "netbsd"))]
 pub mod mqueue;
 #[deny(missing_docs)]
-#[cfg(not(target_os = "redox"))]
+#[cfg(not(any(target_os = "redox", target_os = "managarm")))]
 pub mod net;
 #[deny(missing_docs)]
+#[cfg(not(target_os = "managarm"))]
 pub mod poll;
 #[deny(missing_docs)]
-#[cfg(not(any(target_os = "redox", target_os = "fuchsia")))]
+#[cfg(not(any(target_os = "redox", target_os = "fuchsia", target_os = "managarm")))]
 pub mod pty;
+#[cfg(not(target_os = "managarm"))]
 pub mod sched;
+#[cfg(not(target_os = "managarm"))]
 pub mod sys;
+#[cfg(not(target_os = "managarm"))]
 pub mod time;
 // This can be implemented for other platforms as soon as libc
 // provides bindings for them.
 #[cfg(all(target_os = "linux",
           any(target_arch = "x86", target_arch = "x86_64")))]
 pub mod ucontext;
+#[cfg(not(target_os = "managarm"))]
 pub mod unistd;
 
 /*
-- 
2.32.0

